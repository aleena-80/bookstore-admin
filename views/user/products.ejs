<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ocean Books - Shop</title>
  <link rel="stylesheet" href="/styles/product.css">
</head>
<body>
  <header>
    <nav class="navbar">
      <div class="logo">
        <h1><a href="/users/landing">Ocean Books</a></h1>
        <p class="tagline">Dive into a Sea of Stories</p>
      </div>
      <ul class="nav-links">
        <li><a href="/home">Home</a></li>
        <li><a href="/users/products">Shop</a></li>
        <li><a href="/users/wishlist">Wishlist</a></li>
        <li><a href="/users/profile">Profile</a></li>
        <li><a href="/users/logout">Logout</a></li>
      </ul>
    </nav>
    <div class="filters-bar">
      <input type="text" id="search" placeholder="Search products..." value="<%= search %>">
      <button id="clear-search">Clear</button>
      <select id="sort">
        <option value="" <%= sort === '' ? 'selected' : '' %>>Sort By</option>
        <option value="priceLow" <%= sort === 'priceLow' ? 'selected' : '' %>>Price: Low to High</option>
        <option value="priceHigh" <%= sort === 'priceHigh' ? 'selected' : '' %>>Price: High to Low</option>
        <option value="aZ" <%= sort === 'aZ' ? 'selected' : '' %>>A-Z</option>
        <option value="zA" <%= sort === 'zA' ? 'selected' : '' %>>Z-A</option>
        <option value="new" <%= sort === 'new' ? 'selected' : '' %>>New Arrivals</option>
        <option value="featured" <%= sort === 'featured' ? 'selected' : '' %>>Featured</option>
      </select>
      <label>Category:</label>
      <select id="category">
        <option value="" <%= category === '' ? 'selected' : '' %>>All</option>
        <% categories.forEach(cat => { %>
          <option value="<%= cat._id %>" <%= category === cat._id ? 'selected' : '' %>><%= cat.name %></option>
        <% }); %>
      </select>
      <label>Price Range:</label>
      <input type="number" id="priceMin" placeholder="Min" min="0" value="<%= priceMin %>">
      <input type="number" id="priceMax" placeholder="Max" min="0" value="<%= priceMax %>">
    </div>
  </header>

  <main>
    <section class="products-section">
      <div class="breadcrumbs">
        <a href="/home">Home</a> › Shop
      </div>
      <div id="product-list" class="product-grid" data-current-page="<%= currentPage %>">
        <% if (products && products.length > 0) { %>
          <% products.forEach(product => { %>
            <% const discountedPrice = product.price * (1 - (product.discount || 0) / 100); %>
            <div class="product-card">
              <img src="/images/<%= product.images[0] || '/images/default.jpg' %>" alt="<%= product.name %>">
              <a href="/users/products/<%= product._id %>" class="product-title"><%= product.name %></a>
              <p class="language">Language: <%= product.language %></p>
              <p>₹<%= discountedPrice.toFixed(2) %> 
                <% if (product.discount > 0) { %>
                  <span class="original-price">₹<%= product.price.toFixed(2) %></span>
                <% } %>
              </p>
              <p><%= product.stock > 0 ? 'In Stock' : 'Out of Stock' %></p>
              <button class="wishlist-btn" data-product-id="<%= product._id %>">❤️</button>
            </div>
          <% }); %>
        <% } else { %>
          <p class="no-products">No products available for this filter.</p>
        <% } %>
      </div>
      <div class="pagination">
        <% for (let i = 1; i <= totalPages; i++) { %>
          <a href="#" class="page-link <%= i === currentPage ? 'active' : '' %>" data-page="<%= i %>"><%= i %></a>
        <% } %>
      </div>
    </section>
  </main>

  <!-- Footer unchanged -->

  <script>
    async function loadProducts(page = 1) {
      const search = document.getElementById('search').value || '';
      const sort = document.getElementById('sort').value || '';
      const category = document.getElementById('category').value || '';
      const priceMin = document.getElementById('priceMin').value || '';
      const priceMax = document.getElementById('priceMax').value || '';

      try {
        const response = await fetch(`/users/products?search=${encodeURIComponent(search)}&sort=${sort}&category=${category}&priceMin=${priceMin}&priceMax=${priceMax}&page=${page}&limit=10`, {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        const data = await response.json();

        const productList = document.getElementById('product-list');
        productList.innerHTML = '';
        if (data.success && data.products.length > 0) {
          data.products.forEach(product => {
            const discountedPrice = product.price * (1 - product.discount / 100);
            productList.innerHTML += `
              <div class="product-card">
                <img src="/images/${product.images[0] || '/images/default.jpg'}" alt="${product.name}">
                <a href="/users/products/${product._id}" class="product-title">${product.name}</a>
                <p class="language">Language: ${product.language}</p>
                <p>₹${discountedPrice.toFixed(2)} ${product.discount > 0 ? `<span class="original-price">₹${product.price.toFixed(2)}</span>` : ''}</p>
                <p>${product.stock > 0 ? 'In Stock' : 'Out of Stock'}</p>
                <button class="wishlist-btn" data-product-id="${product._id}">❤️</button>
              </div>
            `;
          });
        } else {
          productList.innerHTML = '<p class="no-products">No products available for this filter.</p>';
        }

        const pagination = document.querySelector('.pagination');
        pagination.innerHTML = '';
        if (data.totalPages > 1) {
          for (let i = 1; i <= data.totalPages; i++) {
            pagination.innerHTML += `
              <a href="#" class="page-link ${i === data.currentPage ? 'active' : ''}" data-page="${i}">${i}</a>
            `;
          }
        }

        document.querySelectorAll('.page-link').forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const newPage = link.dataset.page;
            window.history.pushState({}, '', `?page=${newPage}`);
            loadProducts(newPage);
          });
        });

        document.querySelectorAll('.wishlist-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const productId = btn.dataset.productId;
            alert(`Add product ${productId} to wishlist - not implemented yet!`);
          });
        });
      } catch (error) {
        console.error('Error loading products:', error);
        document.getElementById('product-list').innerHTML = '<p>Error loading products. Please try again.</p>';
      }
    }

    document.getElementById('search').addEventListener('input', () => loadProducts(1));
    document.getElementById('clear-search').addEventListener('click', () => {
      document.getElementById('search').value = '';
      loadProducts(1);
    });
    document.getElementById('sort').addEventListener('change', () => loadProducts(1));
    document.getElementById('category').addEventListener('change', () => loadProducts(1));
    document.getElementById('priceMin').addEventListener('input', () => loadProducts(1));
    document.getElementById('priceMax').addEventListener('input', () => loadProducts(1));

    const productList = document.getElementById('product-list');
    const initialPage = Number(productList.dataset.currentPage) || 1;
    loadProducts(initialPage);
  </script>
</body>
</html>